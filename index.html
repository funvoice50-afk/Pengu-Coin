<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads to Earning Money - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #1f2937; color: #d1d5db; }
        .sidebar a { border-left: 3px solid transparent; transition: all 0.2s; }
        .sidebar a:hover { background-color: #374151; }
        .sidebar a.active { background-color: #4f46e5; color: white; border-left-color: #818cf8; }
        .stat-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background-color: #d1fae5; color: #065f46; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-danger { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div id="admin-login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-center text-gray-900">Admin Panel Login</h1>
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 border rounded-lg">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg">
            <button id="admin-login-btn" class="w-full btn btn-primary">Login</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen">
            <aside class="sidebar w-64 flex-shrink-0">
                <div class="p-4 text-2xl font-bold text-white">Ads to Earning Admin</div>
                <nav class="mt-8">
                    <a href="#" class="nav-link block py-3 px-4" data-page="dashboard-page">
                        <i data-lucide="home" class="inline-block w-5 h-5 mr-2"></i>Dashboard
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="users-page">
                        <i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Users
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="withdrawals-page">
                        <i data-lucide="dollar-sign" class="inline-block w-5 h-5 mr-2"></i>Withdrawals
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="referral-page">
                        <i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Referral System
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="notifications-page">
                        <i data-lucide="send" class="inline-block w-5 h-5 mr-2"></i>Notifications
                    </a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="settings-page">
                        <i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i>Settings
                    </a>
                    <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8">
                        <i data-lucide="log-out" class="inline-block w-5 h-5 mr-2"></i>Logout
                    </a>
                </nav>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Total Users</h2>
                            <p id="total-users" class="text-4xl font-bold mt-2">0</p>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Pending Withdrawals</h2>
                            <p id="pending-withdrawals" class="text-4xl font-bold mt-2">0</p>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Total Ads Watched</h2>
                            <p id="total-ads-watched" class="text-4xl font-bold mt-2">0</p>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Total Taka Distributed</h2>
                            <p id="total-taka-distributed" class="text-4xl font-bold mt-2">৳ 0</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Recent Users</h2>
                            <div id="recent-users-list" class="space-y-3">
                                <!-- Recent users will be loaded here -->
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
                            <div class="space-y-3">
                                <button onclick="navigateTo('settings-page')" class="w-full btn btn-primary">
                                    <i data-lucide="settings" class="inline-block w-4 h-4 mr-2"></i>
                                    Update App Settings
                                </button>
                                <button onclick="navigateTo('notifications-page')" class="w-full btn btn-success">
                                    <i data-lucide="send" class="inline-block w-4 h-4 mr-2"></i>
                                    Send Notification
                                </button>
                                <button onclick="loadUsers()" class="w-full btn btn-warning">
                                    <i data-lucide="refresh-cw" class="inline-block w-4 h-4 mr-2"></i>
                                    Refresh Users List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="users-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">User Management</h1>
                    <div class="mb-6 flex justify-between items-center">
                        <div class="flex space-x-2">
                            <input type="text" id="user-search" placeholder="Search by name or Telegram ID..." 
                                   class="px-4 py-2 border rounded-lg w-64">
                            <button onclick="searchUsers()" class="btn btn-primary">Search</button>
                            <button onclick="clearSearch()" class="btn">Clear</button>
                        </div>
                        <div class="text-sm text-gray-500">
                            Showing <span id="user-count">0</span> users
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Telegram ID</th>
                                    <th>Balance (৳)</th>
                                    <th>Ads Watched</th>
                                    <th>Referrals</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <div id="user-pagination" class="flex space-x-2"></div>
                    </div>
                </div>

                <!-- Withdrawals Page -->
                <div id="withdrawals-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">Withdrawal Requests</h1>
                    <div class="mb-4 flex space-x-4">
                        <button onclick="filterWithdrawals('all')" class="btn">All</button>
                        <button onclick="filterWithdrawals('pending')" class="btn btn-warning">Pending</button>
                        <button onclick="filterWithdrawals('approved')" class="btn btn-success">Approved</button>
                        <button onclick="filterWithdrawals('rejected')" class="btn btn-danger">Rejected</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>User Name</th>
                                    <th>Telegram ID</th>
                                    <th>Amount (৳)</th>
                                    <th>Method</th>
                                    <th>Account</th>
                                    <th>Requested</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawals-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Referral System Page -->
                <div id="referral-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">Referral System Management</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Total Referrals</h2>
                            <p id="total-referrals" class="text-4xl font-bold mt-2">0</p>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Referral Bonus Distributed</h2>
                            <p id="total-referral-bonus" class="text-4xl font-bold mt-2">৳ 0</p>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-gray-500 text-lg">Active Referrers</h2>
                            <p id="active-referrers" class="text-4xl font-bold mt-2">0</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-4">Configure Referral Bot Link</h2>
                        <div class="stat-card p-6">
                            <div class="mb-4">
                                <label class="block font-semibold mb-2">Referral Bot Base URL</label>
                                <input type="text" id="referral-bot-url" class="w-full px-4 py-2 border rounded-lg" 
                                       placeholder="https://t.me/your_bot">
                                <p class="text-sm text-gray-500 mt-1">
                                    Users will get referral links like: [base_url]?start=[referral_code]
                                </p>
                            </div>
                            <button onclick="saveReferralBotUrl()" class="btn btn-primary">Save Bot URL</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-4">Top Referrers</h2>
                        <div class="bg-white shadow rounded-lg overflow-x-auto">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>User</th>
                                        <th>Referral Code</th>
                                        <th>Total Referrals</th>
                                        <th>Bonus Earned</th>
                                        <th>Link</th>
                                    </tr>
                                </thead>
                                <tbody id="top-referrers-table"></tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold mb-4">Referral Statistics</h2>
                        <div class="stat-card p-6">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block font-semibold mb-2">Referrer Bonus (৳)</label>
                                    <input type="number" id="ref-bonus-referrer" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Referee Bonus (৳)</label>
                                    <input type="number" id="ref-bonus-referee" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block font-semibold mb-2">Min Withdraw Referrals</label>
                                    <input type="number" id="ref-withdraw-count" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="saveReferralSettings()" class="btn btn-primary w-full">
                                        Save Referral Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Page -->
                <div id="notifications-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">Send Notifications</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="stat-card p-6">
                            <div class="mb-4">
                                <label class="block font-semibold mb-2">Title</label>
                                <input type="text" id="notification-title" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div class="mb-6">
                                <label class="block font-semibold mb-2">Message</label>
                                <textarea id="notification-message" rows="6" class="w-full px-4 py-2 border rounded-lg"></textarea>
                            </div>
                            <div class="mb-6">
                                <label class="block font-semibold mb-2">Send To</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="send-to" value="all" checked class="mr-2">
                                        All Users
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="send-to" value="active" class="mr-2">
                                        Active Users (watched ads in last 7 days)
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="send-to" value="with-balance" class="mr-2">
                                        Users with balance > ৳ 100
                                    </label>
                                </div>
                            </div>
                            <button id="send-notification-btn" class="btn btn-primary w-full">Send Notification</button>
                        </div>
                        
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Recent Notifications</h2>
                            <div id="recent-notifications" class="space-y-4">
                                <!-- Notifications will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page">
                    <h1 class="text-3xl font-bold mb-6">App Settings</h1>
                    <div class="stat-card p-6 max-w-2xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block font-semibold mb-2">Minimum Withdrawal (৳)</label>
                                <input type="number" id="min-withdrawal" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Daily Ad Limit</label>
                                <input type="number" id="daily-ad-limit" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Reward Per Ad (৳)</label>
                                <input type="number" id="ad-reward-points" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Withdrawal Referral Count</label>
                                <input type="number" id="ref-withdraw-count-settings" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Referrer Bonus (৳)</label>
                                <input type="number" id="ref-bonus-referrer-settings" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Referee Bonus (৳)</label>
                                <input type="number" id="ref-bonus-referee-settings" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label class="block font-semibold mb-2">Payment Methods (comma separated)</label>
                            <input type="text" id="payment-methods" class="w-full px-4 py-2 border rounded-lg" 
                                   placeholder="Example: bKash, Nagad, Rocket">
                        </div>
                        
                        <div class="mt-6">
                            <label class="block font-semibold mb-2">Telegram Bot Token</label>
                            <input type="text" id="telegram-bot-token" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        
                        <div class="mt-6">
                            <label class="block font-semibold mb-2">Telegram Chat ID</label>
                            <input type="text" id="telegram-chat-id" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        
                        <div class="mt-6">
                            <label class="block font-semibold mb-2">Monetag Zone ID</label>
                            <input type="text" id="monetag-zone-id" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        
                        <div class="mt-8">
                            <button id="save-settings-btn" class="btn btn-primary w-full py-3">Save All Settings</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="alert-message" class="mb-4 text-gray-800"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-6">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
            <p id="confirm-message" class="mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-200 text-gray-800 px-6">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASMBf-fL9tJOj2sgKdpVK77TYRMga1bag",
            authDomain: "money-host-56ee9.firebaseapp.com",
            projectId: "money-host-56ee9",
            storageBucket: "money-host-56ee9.firebasestorage.app",
            messagingSenderId: "701262930342",
            appId: "1:701262930342:web:d992e12673ceba55ff2f67"
        };
        
        const ADMIN_UIDS = ["3jTr4Bc6bAbfBaMgJvBzniJPMWq1"];

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard');

        // Global variables
        let currentUsers = [];
        let filteredUsers = [];
        let usersPerPage = 20;
        let currentPage = 1;
        let referralBotUrl = "https://t.me/Ads_to_Earning25_bot";

        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, (user) => {
                if (user && ADMIN_UIDS.includes(user.uid)) {
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'block';
                    navigateTo('dashboard-page');
                    loadDashboardData();
                    loadUsers();
                    loadWithdrawals();
                    loadSettings();
                    loadReferralData();
                    loadRecentNotifications();
                } else {
                    loginView.style.display = 'flex';
                    dashboardView.style.display = 'none';
                }
            });
        };

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === pageId) link.classList.add('active');
            });
            
            // Refresh data when navigating
            if (pageId === 'dashboard-page') {
                loadDashboardData();
            } else if (pageId === 'users-page') {
                loadUsers();
            } else if (pageId === 'withdrawals-page') {
                loadWithdrawals();
            } else if (pageId === 'referral-page') {
                loadReferralData();
            } else if (pageId === 'notifications-page') {
                loadRecentNotifications();
            }
        }

        function setupEventListeners() {
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth).then(() => {
                window.location.reload();
            }));
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('send-notification-btn').addEventListener('click', sendNotification);
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); });
            });
            
            // Search functionality
            document.getElementById('user-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchUsers();
                }
            });
        }

        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) { 
                showAlert(error.message);
            }
        }

        async function loadDashboardData() {
            // Load total users
            const usersSnapshot = await getDocs(collection(db, "users"));
            document.getElementById('total-users').textContent = usersSnapshot.size;
            
            // Load pending withdrawals
            const pendingQuery = query(collection(db, "withdrawals"), where("status", "==", "pending"));
            const pendingSnapshot = await getDocs(pendingQuery);
            document.getElementById('pending-withdrawals').textContent = pendingSnapshot.size;
            
            // Calculate total ads watched and total taka distributed
            let totalAds = 0;
            let totalTaka = 0;
            let totalReferralBonus = 0;
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                totalAds += user.totalAdsWatchedLifetime || 0;
                totalTaka += user.points || 0;
                
                // Calculate referral bonus (approximate)
                if (user.referredUsers && user.referredUsers.length > 0) {
                    totalReferralBonus += (user.referredUsers.length * 10); // 10 per referral
                }
            });
            
            document.getElementById('total-ads-watched').textContent = totalAds.toLocaleString();
            document.getElementById('total-taka-distributed').textContent = `৳ ${totalTaka.toLocaleString()}`;
            
            // Load recent users
            const recentUsersQuery = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(5));
            const recentUsersSnapshot = await getDocs(recentUsersQuery);
            const recentUsersList = document.getElementById('recent-users-list');
            recentUsersList.innerHTML = '';
            
            recentUsersSnapshot.forEach(doc => {
                const user = doc.data();
                const date = user.createdAt?.toDate?.().toLocaleDateString() || 'N/A';
                recentUsersList.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold">${user.name || 'N/A'}</p>
                            <p class="text-sm text-gray-500">ID: ${user.telegramId || 'Guest'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-green-600">৳ ${user.points || 0}</p>
                            <p class="text-sm text-gray-500">${date}</p>
                        </div>
                    </div>
                `;
            });
        }

        async function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            
            const usersSnapshot = await getDocs(collection(db, "users"));
            currentUsers = [];
            filteredUsers = [];
            
            usersSnapshot.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                currentUsers.push(user);
                
                // Filter if search term exists
                if (!searchTerm || 
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.telegramId && user.telegramId.toString().includes(searchTerm)) ||
                    (user.referralCode && user.referralCode.toLowerCase().includes(searchTerm))) {
                    filteredUsers.push(user);
                }
            });
            
            // Sort by points descending
            filteredUsers.sort((a, b) => (b.points || 0) - (a.points || 0));
            
            // Update user count
            document.getElementById('user-count').textContent = filteredUsers.length;
            
            // Pagination
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);
            
            usersTableBody.innerHTML = '';
            
            usersToShow.forEach((user, index) => {
                const isBlocked = user.isBlocked || false;
                const referralCount = user.referredUsers ? user.referredUsers.length : 0;
                const joinDate = user.createdAt?.toDate?.().toLocaleDateString() || 'N/A';
                
                const row = `
                    <tr class="${isBlocked ? 'bg-red-50' : ''}">
                        <td class="font-medium">${user.name || 'N/A'}</td>
                        <td class="text-sm text-gray-500">${user.telegramId || 'Guest'}</td>
                        <td class="font-bold text-green-600">৳ ${user.points || 0}</td>
                        <td>${user.totalAdsWatchedLifetime || 0}</td>
                        <td>
                            <span class="badge ${referralCount > 0 ? 'badge-success' : 'badge-warning'}">
                                ${referralCount} refs
                            </span>
                        </td>
                        <td class="text-sm text-gray-500">${joinDate}</td>
                        <td>
                            <span class="badge ${isBlocked ? 'badge-danger' : 'badge-success'}">
                                ${isBlocked ? 'Blocked' : 'Active'}
                            </span>
                        </td>
                        <td class="space-x-2">
                            <button class="btn btn-primary text-xs" onclick="viewUserDetails('${user.id}')">
                                View
                            </button>
                            <button class="btn ${isBlocked ? 'btn-success' : 'btn-danger'} text-xs" 
                                    onclick="toggleBlockUser('${user.id}', ${isBlocked})">
                                ${isBlocked ? 'Unblock' : 'Block'}
                            </button>
                        </td>
                    </tr>
                `;
                usersTableBody.innerHTML += row;
            });
            
            // Render pagination
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationDiv = document.getElementById('user-pagination');
            paginationDiv.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                paginationDiv.innerHTML += `
                    <button onclick="changePage(${currentPage - 1})" class="btn">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                `;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || 
                    (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationDiv.innerHTML += `
                        <button onclick="changePage(${i})" 
                                class="btn ${i === currentPage ? 'btn-primary' : ''}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationDiv.innerHTML += `<span class="px-3 py-2">...</span>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationDiv.innerHTML += `
                    <button onclick="changePage(${currentPage + 1})" class="btn">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                `;
            }
        }

        function changePage(page) {
            currentPage = page;
            loadUsers();
        }

        function searchUsers() {
            currentPage = 1;
            loadUsers();
        }

        function clearSearch() {
            document.getElementById('user-search').value = '';
            searchUsers();
        }

        async function loadWithdrawals(status = 'all') {
            const withdrawalsTableBody = document.getElementById('withdrawals-table-body');
            
            let withdrawalsQuery;
            if (status === 'all') {
                withdrawalsQuery = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            } else {
                withdrawalsQuery = query(
                    collection(db, "withdrawals"), 
                    where("status", "==", status),
                    orderBy("requestedAt", "desc")
                );
            }
            
            const snapshot = await getDocs(withdrawalsQuery);
            withdrawalsTableBody.innerHTML = '';
            
            if (snapshot.empty) {
                withdrawalsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            No withdrawal requests found
                        </td>
                    </tr>
                `;
                return;
            }
            
            snapshot.forEach(docSnap => {
                const request = docSnap.data();
                const requestedDate = request.requestedAt?.toDate().toLocaleString() || 'N/A';
                
                let statusBadge;
                switch(request.status) {
                    case 'pending':
                        statusBadge = '<span class="badge badge-warning">Pending</span>';
                        break;
                    case 'approved':
                        statusBadge = '<span class="badge badge-success">Approved</span>';
                        break;
                    case 'rejected':
                        statusBadge = '<span class="badge badge-danger">Rejected</span>';
                        break;
                    default:
                        statusBadge = `<span class="badge">${request.status}</span>`;
                }
                
                let actionButtons = '';
                if (request.status === 'pending') {
                    actionButtons = `
                        <button class="btn btn-success text-xs" onclick="handleWithdrawal('${docSnap.id}', 'approved')">
                            Approve
                        </button>
                        <button class="btn btn-danger text-xs" onclick="handleWithdrawal('${docSnap.id}', 'rejected')">
                            Reject
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn btn-primary text-xs" onclick="viewWithdrawalDetails('${docSnap.id}')">
                            View
                        </button>
                    `;
                }
                
                const row = `
                    <tr>
                        <td>${request.userName || 'N/A'}</td>
                        <td class="text-sm text-gray-500">${request.telegramId || 'N/A'}</td>
                        <td class="font-bold">৳ ${request.amount}</td>
                        <td>${request.method}</td>
                        <td class="text-sm">${request.paymentDetail || 'N/A'}</td>
                        <td class="text-sm text-gray-500">${requestedDate}</td>
                        <td>${statusBadge}</td>
                        <td class="space-x-2">${actionButtons}</td>
                    </tr>
                `;
                withdrawalsTableBody.innerHTML += row;
            });
        }

        function filterWithdrawals(status) {
            loadWithdrawals(status);
        }

        async function loadReferralData() {
            // Load referral statistics
            const usersSnapshot = await getDocs(collection(db, "users"));
            
            let totalReferrals = 0;
            let totalReferralBonus = 0;
            let activeReferrers = 0;
            let topReferrers = [];
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const referralCount = user.referredUsers ? user.referredUsers.length : 0;
                
                if (referralCount > 0) {
                    totalReferrals += referralCount;
                    totalReferralBonus += (referralCount * 10); // 10 Taka per referral
                    activeReferrers++;
                    
                    topReferrers.push({
                        name: user.name,
                        referralCode: user.referralCode,
                        referrals: referralCount,
                        bonus: referralCount * 10,
                        telegramId: user.telegramId
                    });
                }
            });
            
            // Update statistics
            document.getElementById('total-referrals').textContent = totalReferrals.toLocaleString();
            document.getElementById('total-referral-bonus').textContent = `৳ ${totalReferralBonus.toLocaleString()}`;
            document.getElementById('active-referrers').textContent = activeReferrers;
            
            // Sort top referrers
            topReferrers.sort((a, b) => b.referrals - a.referrals);
            
            // Display top referrers
            const topReferrersTable = document.getElementById('top-referrers-table');
            topReferrersTable.innerHTML = '';
            
            topReferrers.slice(0, 10).forEach((referrer, index) => {
                const referralLink = `${referralBotUrl}?start=${referrer.referralCode}`;
                const row = `
                    <tr>
                        <td class="font-bold">#${index + 1}</td>
                        <td>${referrer.name || 'N/A'}</td>
                        <td>
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">
                                ${referrer.referralCode}
                            </span>
                        </td>
                        <td class="font-bold">${referrer.referrals}</td>
                        <td class="text-green-600 font-bold">৳ ${referrer.bonus}</td>
                        <td>
                            <button onclick="copyToClipboard('${referralLink}')" 
                                    class="btn btn-primary text-xs">
                                Copy Link
                            </button>
                        </td>
                    </tr>
                `;
                topReferrersTable.innerHTML += row;
            });
            
            if (topReferrers.length === 0) {
                topReferrersTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            No referral data available
                        </td>
                    </tr>
                `;
            }
        }

        async function loadSettings() {
            const configRef = doc(db, "config", "main");
            const referralConfigRef = doc(db, "config", "referral");
            
            try {
                // Load main config
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    const config = configSnap.data();
                    document.getElementById('min-withdrawal').value = config.minWithdrawal || '';
                    document.getElementById('daily-ad-limit').value = config.dailyAdLimit || '';
                    document.getElementById('ad-reward-points').value = config.adRewardPoints || '';
                    document.getElementById('payment-methods').value = (config.paymentMethods || []).join(', ');
                    
                    // Load referral settings
                    document.getElementById('ref-withdraw-count-settings').value = config.refWithdrawCount || '';
                    document.getElementById('ref-bonus-referrer-settings').value = config.refBonusReferrer || '';
                    document.getElementById('ref-bonus-referee-settings').value = config.refBonusReferee || '';
                    
                    // Also update referral page
                    document.getElementById('ref-withdraw-count').value = config.refWithdrawCount || '';
                    document.getElementById('ref-bonus-referrer').value = config.refBonusReferrer || '';
                    document.getElementById('ref-bonus-referee').value = config.refBonusReferee || '';
                }
                
                // Load referral bot URL
                const referralSnap = await getDoc(referralConfigRef);
                if (referralSnap.exists()) {
                    const referralConfig = referralSnap.data();
                    referralBotUrl = referralConfig.botUrl || "https://t.me/Ads_to_Earning25_bot";
                    document.getElementById('referral-bot-url').value = referralBotUrl;
                }
                
                // Load telegram config
                const telegramConfigRef = doc(db, "config", "telegram");
                const telegramSnap = await getDoc(telegramConfigRef);
                if (telegramSnap.exists()) {
                    const telegramConfig = telegramSnap.data();
                    document.getElementById('telegram-bot-token').value = telegramConfig.botToken || '';
                    document.getElementById('telegram-chat-id').value = telegramConfig.chatId || '';
                }
                
                // Load monetag config
                const monetagConfigRef = doc(db, "config", "monetag");
                const monetagSnap = await getDoc(monetagConfigRef);
                if (monetagSnap.exists()) {
                    const monetagConfig = monetagSnap.data();
                    document.getElementById('monetag-zone-id').value = monetagConfig.zoneId || '';
                }
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showAlert("Error loading settings: " + error.message);
            }
        }

        async function saveSettings() {
            const minWithdrawal = parseInt(document.getElementById('min-withdrawal').value);
            const dailyAdLimit = parseInt(document.getElementById('daily-ad-limit').value);
            const adRewardPoints = parseInt(document.getElementById('ad-reward-points').value);
            const refWithdrawCount = parseInt(document.getElementById('ref-withdraw-count-settings').value);
            const refBonusReferrer = parseInt(document.getElementById('ref-bonus-referrer-settings').value);
            const refBonusReferee = parseInt(document.getElementById('ref-bonus-referee-settings').value);
            const paymentMethods = document.getElementById('payment-methods').value.split(',').map(s => s.trim()).filter(Boolean);
            const telegramBotToken = document.getElementById('telegram-bot-token').value.trim();
            const telegramChatId = document.getElementById('telegram-chat-id').value.trim();
            const monetagZoneId = document.getElementById('monetag-zone-id').value.trim();
            
            if (isNaN(minWithdrawal) || isNaN(dailyAdLimit) || isNaN(adRewardPoints) || 
                isNaN(refWithdrawCount) || isNaN(refBonusReferrer) || isNaN(refBonusReferee)) {
                return showAlert("Please enter valid numbers in all numeric fields.");
            }
            
            try {
                // Save main config
                await setDoc(doc(db, "config", "main"), { 
                    minWithdrawal, 
                    dailyAdLimit, 
                    adRewardPoints,
                    refWithdrawCount,
                    refBonusReferrer,
                    refBonusReferee,
                    paymentMethods,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                // Save telegram config
                if (telegramBotToken || telegramChatId) {
                    await setDoc(doc(db, "config", "telegram"), {
                        botToken: telegramBotToken,
                        chatId: telegramChatId,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                }
                
                // Save monetag config
                if (monetagZoneId) {
                    await setDoc(doc(db, "config", "monetag"), {
                        zoneId: monetagZoneId,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                }
                
                showAlert("All settings have been saved successfully!");
                
                // Update referral page with new values
                document.getElementById('ref-withdraw-count').value = refWithdrawCount;
                document.getElementById('ref-bonus-referrer').value = refBonusReferrer;
                document.getElementById('ref-bonus-referee').value = refBonusReferee;
                
            } catch (error) {
                showAlert("Error saving settings: " + error.message);
            }
        }

        async function saveReferralSettings() {
            const refBonusReferrer = parseInt(document.getElementById('ref-bonus-referrer').value);
            const refBonusReferee = parseInt(document.getElementById('ref-bonus-referee').value);
            const refWithdrawCount = parseInt(document.getElementById('ref-withdraw-count').value);
            
            if (isNaN(refBonusReferrer) || isNaN(refBonusReferee) || isNaN(refWithdrawCount)) {
                return showAlert("Please enter valid numbers for referral settings.");
            }
            
            try {
                await setDoc(doc(db, "config", "main"), { 
                    refBonusReferrer,
                    refBonusReferee,
                    refWithdrawCount,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                // Also update settings page
                document.getElementById('ref-withdraw-count-settings').value = refWithdrawCount;
                document.getElementById('ref-bonus-referrer-settings').value = refBonusReferrer;
                document.getElementById('ref-bonus-referee-settings').value = refBonusReferee;
                
                showAlert("Referral settings have been saved successfully!");
            } catch (error) {
                showAlert("Error saving referral settings: " + error.message);
            }
        }

        async function saveReferralBotUrl() {
            const botUrl = document.getElementById('referral-bot-url').value.trim();
            
            if (!botUrl) {
                return showAlert("Please enter a valid bot URL.");
            }
            
            try {
                await setDoc(doc(db, "config", "referral"), {
                    botUrl: botUrl,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                referralBotUrl = botUrl;
                showAlert("Referral bot URL has been saved successfully!");
                
                // Refresh referral data
                loadReferralData();
            } catch (error) {
                showAlert("Error saving bot URL: " + error.message);
            }
        }

        async function sendNotification() {
            const title = document.getElementById('notification-title').value.trim();
            const message = document.getElementById('notification-message').value.trim();
            const sendTo = document.querySelector('input[name="send-to"]:checked').value;
            
            if (!title || !message) {
                return showAlert("Both title and message are required.");
            }
            
            try {
                // Save notification to database
                await addDoc(collection(db, "notifications"), { 
                    title, 
                    message, 
                    sendTo,
                    createdAt: serverTimestamp(),
                    sentBy: auth.currentUser.email 
                });
                
                showAlert("Notification has been sent to all users!");
                document.getElementById('notification-title').value = '';
                document.getElementById('notification-message').value = '';
                
                // Refresh recent notifications
                loadRecentNotifications();
                
            } catch (error) {
                showAlert("Error sending notification: " + error.message);
            }
        }

        async function loadRecentNotifications() {
            const recentNotificationsDiv = document.getElementById('recent-notifications');
            const notificationsQuery = query(
                collection(db, "notifications"), 
                orderBy("createdAt", "desc"), 
                limit(5)
            );
            
            const snapshot = await getDocs(notificationsQuery);
            recentNotificationsDiv.innerHTML = '';
            
            if (snapshot.empty) {
                recentNotificationsDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        No notifications sent yet
                    </div>
                `;
                return;
            }
            
            snapshot.forEach(docSnap => {
                const notification = docSnap.data();
                const date = notification.createdAt?.toDate().toLocaleString() || 'N/A';
                
                recentNotificationsDiv.innerHTML += `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold">${notification.title}</h3>
                            <span class="text-sm text-gray-500">${date}</span>
                        </div>
                        <p class="text-gray-600 mb-2">${notification.message}</p>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Sent to: ${notification.sendTo || 'All users'}</span>
                            <span>By: ${notification.sentBy || 'Admin'}</span>
                        </div>
                    </div>
                `;
            });
        }

        // User management functions
        async function viewUserDetails(userId) {
            try {
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const user = userSnap.data();
                    const joinDate = user.createdAt?.toDate().toLocaleString() || 'N/A';
                    const lastActive = user.lastAdWatchDate || 'N/A';
                    const referralCount = user.referredUsers ? user.referredUsers.length : 0;
                    const referralLink = `${referralBotUrl}?start=${user.referralCode}`;
                    
                    const details = `
                        <strong>User Details:</strong><br><br>
                        <strong>Name:</strong> ${user.name || 'N/A'}<br>
                        <strong>Telegram ID:</strong> ${user.telegramId || 'Guest'}<br>
                        <strong>User ID:</strong> ${userId}<br>
                        <strong>Balance:</strong> ৳ ${user.points || 0}<br>
                        <strong>Ads Watched Today:</strong> ${user.adsWatchedToday || 0}<br>
                        <strong>Total Ads Watched:</strong> ${user.totalAdsWatchedLifetime || 0}<br>
                        <strong>Referral Code:</strong> ${user.referralCode || 'N/A'}<br>
                        <strong>Total Referrals:</strong> ${referralCount}<br>
                        <strong>Referral Link:</strong> ${referralLink}<br>
                        <strong>Joined:</strong> ${joinDate}<br>
                        <strong>Last Active:</strong> ${lastActive}<br>
                        <strong>Status:</strong> ${user.isBlocked ? 'Blocked' : 'Active'}<br>
                        <br>
                        <button onclick="copyToClipboard('${referralLink}')" class="btn btn-primary">
                            Copy Referral Link
                        </button>
                    `;
                    
                    showAlert(details);
                }
            } catch (error) {
                showAlert("Error loading user details: " + error.message);
            }
        }

        window.toggleBlockUser = (userId, isBlocked) => {
            const action = isBlocked ? 'unblock' : 'block';
            showConfirm(`Are you sure you want to ${action} this user?`, async () => {
                const userRef = doc(db, "users", userId);
                try {
                    await updateDoc(userRef, { 
                        isBlocked: !isBlocked,
                        blockedAt: !isBlocked ? serverTimestamp() : null
                    });
                    
                    showAlert(`User has been ${action}ed successfully.`);
                    loadUsers(); // Refresh user list
                } catch (error) {
                    showAlert(`Error: ${error.message}`);
                }
            });
        };

        window.handleWithdrawal = (requestId, newStatus) => {
            const statusText = newStatus === 'approved' ? 'approve' : 'reject';
            showConfirm(`Are you sure you want to ${statusText} this withdrawal request?`, async () => {
                const requestRef = doc(db, "withdrawals", requestId);
                try {
                    const requestSnap = await getDoc(requestRef);
                    if (requestSnap.exists()) {
                        const requestData = requestSnap.data();
                        
                        // Handle point refund if rejected
                        if (newStatus === 'rejected') {
                            const userRef = doc(db, "users", requestData.userId);
                            const userSnap = await getDoc(userRef);
                            if(userSnap.exists()){
                               const currentPoints = userSnap.data().points || 0;
                               await updateDoc(userRef, { 
                                   points: currentPoints + requestData.amount 
                               });
                            }
                        }
                        
                        // Update withdrawal status
                        await updateDoc(requestRef, { 
                            status: newStatus,
                            processedAt: serverTimestamp(),
                            processedBy: auth.currentUser.email
                        });
                        
                        showAlert(`Withdrawal request has been ${statusText}ed.`);
                        loadWithdrawals(); // Refresh withdrawals list
                        loadDashboardData(); // Refresh dashboard stats
                    }
                } catch (error) {
                    showAlert(`Error: ${error.message}`);
                }
            });
        };

        async function viewWithdrawalDetails(requestId) {
            try {
                const requestRef = doc(db, "withdrawals", requestId);
                const requestSnap = await getDoc(requestRef);
                
                if (requestSnap.exists()) {
                    const request = requestSnap.data();
                    const requestedDate = request.requestedAt?.toDate().toLocaleString() || 'N/A';
                    const processedDate = request.processedAt?.toDate().toLocaleString() || 'Not processed';
                    
                    const details = `
                        <strong>Withdrawal Details:</strong><br><br>
                        <strong>User Name:</strong> ${request.userName || 'N/A'}<br>
                        <strong>Telegram ID:</strong> ${request.telegramId || 'N/A'}<br>
                        <strong>Amount:</strong> ৳ ${request.amount}<br>
                        <strong>Method:</strong> ${request.method}<br>
                        <strong>Account:</strong> ${request.paymentDetail || 'N/A'}<br>
                        <strong>Status:</strong> ${request.status}<br>
                        <strong>Requested:</strong> ${requestedDate}<br>
                        <strong>Processed:</strong> ${processedDate}<br>
                        <strong>Processed By:</strong> ${request.processedBy || 'N/A'}<br>
                    `;
                    
                    showAlert(details);
                }
            } catch (error) {
                showAlert("Error loading withdrawal details: " + error.message);
            }
        }

        // Utility functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert("Copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showAlert("Failed to copy to clipboard.");
            });
        }

        function showAlert(message) {
            document.getElementById('alert-message').innerHTML = message;
            document.getElementById('custom-alert').classList.remove('hidden');
            document.getElementById('alert-ok-btn').onclick = () => { 
                document.getElementById('custom-alert').classList.add('hidden'); 
            };
        }

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');

            const okListener = () => {
                onConfirm();
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', okListener);
                confirmCancelBtn.removeEventListener('click', cancelListener);
            };

            const cancelListener = () => {
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', okListener);
                confirmCancelBtn.removeEventListener('click', cancelListener);
            };

            confirmOkBtn.addEventListener('click', okListener);
            confirmCancelBtn.addEventListener('click', cancelListener);
        }

        // Make functions available globally
        window.navigateTo = navigateTo;
        window.searchUsers = searchUsers;
        window.clearSearch = clearSearch;
        window.changePage = changePage;
        window.filterWithdrawals = filterWithdrawals;
        window.copyToClipboard = copyToClipboard;
        window.saveReferralSettings = saveReferralSettings;
        window.saveReferralBotUrl = saveReferralBotUrl;
        window.viewUserDetails = viewUserDetails;
        window.viewWithdrawalDetails = viewWithdrawalDetails;

    </script>
</body>
</html>
